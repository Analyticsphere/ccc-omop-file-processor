# OMOP File Processor - Local Development Quick Start

## Prerequisites
- Docker installed and running
- Mac with local filesystem access

## Quick Start (5 minutes)

### 1. Create Local Data Directory
```bash
cd /Users/frankenbergerea/Development/ccc-omop-file-processor
mkdir -p local-data/{temp,logs,vocabulary,deliveries}
```

### 2. Build Docker Image
```bash
docker build -t omop-processor:local .
```

### 3. Run Container
```bash
docker run -d \
  --name omop-processor-local \
  -p 8080:8080 \
  -v /Users/frankenbergerea/Development/ccc-omop-file-processor/local-data:/data \
  -e STORAGE_BACKEND=local \
  -e OMOP_VOCAB_PATH=/data/vocabulary \
  -e BQ_LOGGING_TABLE=local_logs \
  -e DUCKDB_TEMP_DIR=/data/temp/ \
  -e PORT=8080 \
  omop-processor:local
```

### 4. Test Heartbeat Endpoint
```bash
curl http://localhost:8080/heartbeat
```

Expected response:
```json
{
  "service": "omop-file-processor",
  "status": "healthy",
  "timestamp": "2025-12-05T20:56:37.120856"
}
```

## Container Management

### View Logs
```bash
docker logs omop-processor-local
```

### Follow Logs (live)
```bash
docker logs -f omop-processor-local
```

### Stop Container
```bash
docker stop omop-processor-local
```

### Remove Container
```bash
docker rm omop-processor-local
```

### Restart Container
```bash
docker restart omop-processor-local
```

### Full Cleanup (stop and remove)
```bash
docker stop omop-processor-local && docker rm omop-processor-local
```

## Available Endpoints

All endpoints accessible at `http://localhost:8080`

### âœ… Working Endpoints
- `GET /heartbeat` - Health check
- `POST /create_artifact_directories` - Create artifact directory structure
- `GET /get_file_list` - List files in directory by format
- `POST /process_incoming_file` - Convert CSV/Parquet to standardized Parquet
- `POST /validate_file` - Validate file against OMOP schema
- `POST /normalize_parquet` - Normalize parquet to OMOP CDM schema with type conversions
- `POST /upgrade_cdm` - Upgrade OMOP CDM file from one version to another
- `POST /create_optimized_vocab` - Convert vocabulary CSV files to optimized Parquet format
- `POST /harmonize_vocab` - Multi-step vocabulary harmonization (8 steps: source_target, target_remap, target_replacement, domain_check, omop_etl, consolidate_etl, discover_tables_for_dedup, deduplicate_single_table)
- `POST /generate_derived_tables_from_harmonized` - Generate derived tables (drug_era, condition_era, observation_period) from harmonized data
- `POST /generate_delivery_report` - Generate final delivery report CSV consolidating all metadata artifacts

### ðŸš§ To Be Tested
- And more...

## Postman Testing

1. Import collection or create new requests
2. Set base URL: `http://localhost:8080`
3. Start with simple GET requests, then POST

## Environment Variables Explained

| Variable | Value | Purpose |
|----------|-------|---------|
| `STORAGE_BACKEND` | `local` | Use local filesystem instead of cloud storage |
| `DATA_ROOT` | `/data` | Root directory for local file storage (configurable) |
| `OMOP_VOCAB_PATH` | `/data/vocabulary` | Path to OMOP vocabulary files |
| `BQ_LOGGING_TABLE` | `local_logs` | Mock BigQuery logging |
| `DUCKDB_TEMP_DIR` | `/data/temp/` | DuckDB temporary directory |
| `PORT` | `8080` | Internal container port |

**Note:** `DATA_ROOT` allows you to change where files are stored. Default is `/data`, but you can mount volumes anywhere and update this variable.

## Directory Structure

```
local-data/
â”œâ”€â”€ temp/           # DuckDB temporary files
â”œâ”€â”€ logs/           # Pipeline execution logs
â”œâ”€â”€ vocabulary/     # OMOP vocabulary CSV files
â””â”€â”€ deliveries/     # Test OMOP data files
    â””â”€â”€ test_site/
        â””â”€â”€ 2025-12-05/
            â”œâ”€â”€ person.csv
            â”œâ”€â”€ condition_occurrence.csv
            â””â”€â”€ artifacts/  (generated by pipeline)
```

## Troubleshooting

### Container won't start - port already in use
```bash
# Check what's using port 8080
lsof -i :8080

# Stop any old containers
docker ps -a | grep 8080
docker stop <container-name> && docker rm <container-name>

# Or use a different port
docker run -d \
  --name omop-processor-local \
  -p 8081:8080 \  # Changed to 8081
  ...
```

### Container crashes on startup
```bash
# Check logs
docker logs omop-processor-local

# Common issues:
# - Volume mount path doesn't exist
# - Missing environment variables
```

### Can't access endpoint
```bash
# Verify container is running
docker ps | grep omop-processor-local

# Check if port is accessible
curl -v http://localhost:8080/heartbeat

# Verify container networking
docker inspect omop-processor-local | grep IPAddress
```

## Next Steps

See `LOCAL_DEVELOPMENT_PLAN.md` for:
- Full implementation plan
- Endpoint testing checklist
- Known issues and solutions
- Progress tracking
